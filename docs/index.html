<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>moneo | track and trace simulator - Downloads</title>
    <link rel="icon" type="image/svg+xml" href="images/logo.svg">
    <link rel="alternate icon" href="images/logo.ico">
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="images/logo.svg" alt="moneo logo" class="header-logo">
            <h1>moneo | track and trace simulator</h1>
        </div>

        <div id="downloadsContainer" class="downloads-grid">
            <div class="loading">‚è≥ Loading releases...</div>
        </div>

        <section class="readme">
            <div id="readmeContent" class="readme-content">
                <div class="loading">‚è≥ Loading README...</div>
            </div>
        </section>

        <div class="footer">
            <p>¬© Yannick Dreher | <a href="https://github.com/yannickdreher/moneo-track-trace-simulator">GitHub Repository</a></p>
        </div>
    </div>

    <div class="copy-notification" id="copyNotification">
        ‚úì Hash copied to clipboard
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script>
        const REPO_OWNER = 'yannickdreher';
        const REPO_NAME = 'moneo-track-trace-simulator';
        const API_URL = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/releases`;
        const README_URL = 'https://raw.githubusercontent.com/yannickdreher/moneo-track-trace-simulator/refs/heads/master/README.md';

        document.addEventListener('DOMContentLoaded', function () {
            loadReleases();
            loadReadme();
        });

        async function loadReleases() {
            const container = document.getElementById('downloadsContainer');

            try {
                const response = await fetch(API_URL);

                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }

                const releases = await response.json();

                if (releases.length === 0) {
                    container.innerHTML = '<div class="error">üì¶ No releases available yet</div>';
                    return;
                }

                releases.sort((a, b) => new Date(b.published_at) - new Date(a.published_at));

                container.innerHTML = '';

                for (const release of releases) {
                    const card = createDownloadCard(release);
                    if (card) {
                        container.appendChild(card);
                    }
                }

            } catch (error) {
                console.error('Failed to load releases:', error);
                container.innerHTML = `<div class="error">‚ùå Failed to load releases: ${error.message}</div>`;
            }
        }

        function createDownloadCard(release) {
            const version = release.tag_name.replace(/^v/, '');
            const exeAsset = release.assets.find(asset => asset.name.endsWith('.exe'));

            if (!exeAsset) {
                console.warn(`No .exe asset found for release ${release.tag_name}`);
                return null;
            }

            const card = document.createElement('div');
            card.className = 'download-card';

            const releaseDate = new Date(release.published_at).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const sizeInMB = (exeAsset.size / 1024 / 1024).toFixed(2);
            const hash = exeAsset.digest ? exeAsset.digest.replace('sha256:', '').toUpperCase() : null;

            card.innerHTML = `
                    <div class="card-header">
                        <span class="file-icon">üì¶</span>
                        <div class="file-info">
                            <div class="file-name">${exeAsset.name}</div>
                            <div class="file-meta">
                                <span class="meta-item">Windows 64-bit</span>
                                <span class="meta-item">|</span>
                                <span class="meta-item">Version ${version}</span>
                                <span class="meta-item">|</span>
                                <span class="meta-item">${sizeInMB} MB</span>
                            </div>
                            <div class="release-date">Released: ${releaseDate}</div>
                        </div>
                        <a href="${exeAsset.browser_download_url}" class="download-button" download>
                            Download
                        </a>
                    </div>

                    <div class="security-section">
                        <div class="security-title">üîí Security Information</div>
                        <table class="security-table">
                            <tr>
                                <th>SHA256:</th>
                                <td>
                                    <div class="value${hash ? '' : ' error'}" title="Click to copy">
                                        ${hash || 'Not available'}
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>Verify:</th>
                                <td>
                                    <div class="value">
                                        certutil -hashfile ${exeAsset.name} SHA256
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                `;

            if (hash) {
                const hashElement = card.querySelector('.value');
                hashElement.onclick = function () { copyToClipboard(this); };
            }

            return card;
        }

        function copyToClipboard(element) {
            if (element.classList.contains('error')) {
                return;
            }

            const text = element.innerText;
            navigator.clipboard.writeText(text).then(() => {
                const notification = document.getElementById('copyNotification');
                notification.classList.add('show');
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        async function loadReadme() {
            const readmeContent = document.getElementById('readmeContent');

            try {
                const response = await fetch(README_URL);

                if (!response.ok) {
                    throw new Error(`README fetch failed: ${response.status}`);
                }

                const markdown = await response.text();
                const normalized = markdown.replaceAll('docs/images/', 'images/');
                const html = DOMPurify.sanitize(marked.parse(normalized));

                readmeContent.innerHTML = html;
            } catch (error) {
                console.error('Failed to load README:', error);
                readmeContent.innerHTML = `<div class="error">‚ùå Failed to load README: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>